<section class="services">
    <div class="services__container">
        <div class="services__filter filter">
            <form action="search-service.php" method="GET">
                <input type="text" class="filter__search" name="search" placeholder="Поиск" />
                <div class="filter__dropdown">
                    <a href="#openModal2" class="filter__service">
                        <?php
                        if (!isset($_GET['city-order'])) {?>
                            Город
                            <?php
                        } else {
                            echo $_GET['city-order']; } ?>
                    </a>
                </div>
                <div class="filter__dropdown">
                    <?php
                    if (isset($_GET['city-order'])) { $city_order = $_GET['city-order'];b?>
                        <div class="filter__dropdown">
                            <button class="filter__service">Категории услуг</button>
                            <div class="filter__drop-service">
                                <a href="services2.php?category=Замена&city-order=<?= $city_order ?> ">Замена</a>
                                <a href="services2.php?category=Монтаж&city-order=<?= $city_order ?> ">Монтаж</a>
                                <a href="services2.php?category=Полный перечень&city-order=<?= $city_order ?> ">Полный
                                    перечень</a>
                            </div>
                        </div>
                    <?php } else if (isset($_GET['city-order']) && isset($_GET['category']) && isset($_GET['review'])) {
                        $city_order = $_GET['city-order'];?>
                            <div class="filter__dropdown">
                                <button class="filter__service">Категории услуг</button>
                                <div class="filter__drop-service">
                                    <a href="services2.php?category=Замена&city-order=<?= $city_order ?>&review=top">Замена</a>
                                    <a href="services2.php?category=Монтаж&city-order=<?= $city_order ?>&review=top">Монтаж</a>
                                    <a href="services2.php?category=Полный перечень&city-order=<?= $city_order ?>&review=top">Полный
                                        перечень</a></div> </div>
                        <?php } else { ?>
                            <div class="filter__dropdown">
                                <button class="filter__service">Категории услуг</button>
                                <div class="filter__drop-service">
                                    <a href="services2.php?category=Замена">Замена</a>
                                    <a href="services2.php?category=Монтаж">Монтаж</a>
                                    <a href="services2.php?category=Полный перечень">Полный перечень</a></div></div> <?php } ?></div>
                <?php if (isset($_GET['city-order']) && isset($_GET['category'])) {
                    $city_order = $_GET['city-order'];
                    $cat = $_GET['category']; ?>
                    <a href="services2.php?category=<?= $cat ?>&city-order=<?= $city_order ?>&review=top"
                        class="filter__service">Отзывы</a>
                <?php } else { ?>
                    <a href="services2.php?review=top" class="filter__service">Отзывы</a><?php } ?>
<?php if (isset($_GET['city-order'])) {city_order = $_GET['city-order'];?>
                    <div class="filter__dropdown">
                        <button class="filter__service">Сортировка</button>
                        <div class="filter__drop-service">
                            <a href="services2.php?sort=0&city-order=<?= $city_order ?>">По умолчанию</a>
                            <a href="services2.php?sort=1&city-order=<?= $city_order ?>">Цена по возрастанию</a>
                            <a href="services2.php?sort=2&city-order=<?= $city_order ?>">Цена по убыванию</a>
                            <a href="services2.php?sort=3&city-order=<?= $city_order ?>">По дате размещения</a> </div></div>
                <?php } else if (isset($_GET['city-order']) && isset($_GET['category']) && isset($_GET['review'])) {
                    $city_order = $_GET['city-order'];
                    ?>
                        <div class="filter__dropdown">
                            <button class="filter__service">Сортировка</button>
                            <div class="filter__drop-service">
                                <a href="services2.php?sort=0&category=<?= $cat ?>&city-order=<?= $city_order ?>&review=top">По
                                    умолчанию</a>
                                <a href="services2.php?sort=1&category=<?= $cat ?>&city-order=<?= $city_order ?>&review=top">Цена
                                    по
                                    возрастанию</a>
                                <a href="services2.php?sort=2&category=<?= $cat ?>&city-order=<?= $city_order ?>&review=top">Цена
                                    по
                                    убыванию</a>
                                <a href="services2.php?sort=3&category=<?= $cat ?>&city-order=<?= $city_order ?>&review=top">По
                                    дате
                                    размещения</a></div> </div> <?php } else { ?>
                        <div class="filter__dropdown">
                            <button class="filter__service">Сортировка</button>
                            <div class="filter__drop-service">
                                <a href="services2.php?sort=0">По умолчанию</a>
                                <a href="services2.php?sort=1">Цена по возрастанию</a>
                                <a href="services2.php?sort=2">Цена по убыванию</a>
                                <a href="services2.php?sort=3">По дате размещения</a></div> </div><?php } ?> </form></div>
        <ul class="cards">
            <?php
            if (isset($_GET['city-order']) && !empty($_GET['city-order'])) {
                $address = $_GET['city-order'];
                $query_select = "SELECT * FROM table WHERE address LIKE '%$address%' AND order_open='0'";
                if (isset($_GET['category']) && !empty($_GET['category'])) {
                    $cat = $_GET['category'];
                    $query_select .= " AND category='$cat'"; }
                if (isset($_GET['review']) && !empty($_GET['review'])) {
                    $query_select_rate = "SELECT * FROM table2  ORDER BY rating DESC LIMIT 1";
                    $result_rate = mysqli_query($conn, $query_select_rate);
                    $fetch_rate = mysqli_fetch_assoc($result_rate);
                    $rate = $fetch_rate['user_id'];
                    if (isset($cat) && !empty($cat)) {
                        $query_select .= " AND category='$cat'";}
                    $query_select .= " ORDER BY user_id='$rate' ASC";} else {
                    if (isset($_GET['sort']) && !empty($_GET['sort'])) {
                        $sort = $_GET['sort'];
                        if ($sort == 1) {
                            $query_select .= " ORDER BY cost_bef ASC";
                        } else if ($sort == 2) {
                            $query_select .= " ORDER BY cost_bef DESC";
                        } else if ($sort == 3) {
                            $query_select .= " ORDER BY time DESC";} }  }
                $result = mysqli_query($conn, $query_select);
            } else if (isset($_GET['category']) && !empty($_GET['category'])) {
                $cat = $_GET['category'];
                // $query_select = "SELECT * FROM `table` WHERE `category` = '$cat' AND `order_open` = '0' ORDER BY CASE WHEN `address` LIKE '%$selectedCity%' THEN 0 ELSE 1 END DESC";
                $query_select = "SELECT * FROM `table` WHERE `category` = '$cat' AND `order_open` = '0' ORDER BY CASE WHEN `address` LIKE '%$selectedCity%' THEN 0 END DESC";
                if (isset($_GET['review']) && !empty($_GET['review'])) {
                    $query_select_rate = "SELECT * FROM ratee ORDER BY  `rating` DESC";
                    $result_rate = mysqli_query($conn, $query_select_rate);
                    $fetch_rate = mysqli_fetch_assoc($result_rate);
                    $rate = $fetch_rate['user_id'];
                    $query_select .= " ORDER BY user_id='$rate' ASC"; } else {
                    if (isset($_GET['sort']) && !empty($_GET['sort'])) {
                        $sort = $_GET['sort'];
                        if ($sort == 1) {
                            $query_select .= " ORDER BY cost_bef ASC";
                        } else if ($sort == 2) {
                            $query_select .= " ORDER BY cost_bef DESC";
                        } else if ($sort == 3) {
                            $query_select .= " ORDER BY time DESC";} } }
                $result = mysqli_query($conn, $query_select);
            } else {
                if (isset($_GET['review']) && !empty($_GET['review'])) {
                    $query_select_rate = "SELECT * FROM ratee ORDER BY rating DESC LIMIT 1";
                    $result_rate = mysqli_query($conn, $query_select_rate);
                    $fetch_rate = mysqli_fetch_assoc($result_rate);
                    if (isset($fetch_rate)) {
                        $rate = $fetch_rate['user_id'];
                        $query_select = "SELECT * FROM table WHERE order_open='0' ORDER BY user_id='$rate' ASC";
                    } else {
                        $query_select = "SELECT * FROM orders_full WHERE order_open='0'";
                        if (isset($_GET['sort']) && !empty($_GET['sort'])) {
                            $sort = $_GET['sort'];
                            if ($sort == 1) {
                                $query_select .= " ORDER BY cost_bef ASC";
                            } else if ($sort == 2) {
                                $query_select .= " ORDER BY cost_bef DESC";
                            } else if ($sort == 3) {
                                $query_select .= " ORDER BY time DESC";}}}
                    $result = mysqli_query($conn, $query_select); }}
            if (mysqli_num_rows($result) == 0) {
                echo 'Здесь пока ничего нет';}
            while ($order = mysqli_fetch_assoc($result)):
                $order_id = $order['id'];
                $user = $order['user_id'];?>
                <li>
                    <a href="order-user.php?order=<?= $order_id ?>" class="card">
                        <div class="card__thumb">
                            <?php
                            $query_select_me = "SELECT * FROM table3 WHERE profile_id=$user";
                            $result_me = mysqli_query($conn, $query_select_me);
                            $profile_me = mysqli_fetch_assoc($result_me);
                            if (file_exists($profile_me['image'])) { ?>
                                <img src="<?= $profile_me['image'] ?>" width="50" height="50" alt="">
                            <?php } else { ?>
                                <img src="ava.jpg" width="50" height="50" alt=""><?php } ?>
                        </div>
                        <div class="card__overlay">
                            <div class="card__description">
                                <h3 class="card__title">
                                    <?= $profile_me['organization'] ?></h3>
                                <p class="card__description-title">
                                    <?= $order['category'] ?></p>
                                <p class="card__description-rubric">
                                    <?= $order['address'] ?></p>
                                <p class="card__description-rubric">Сумма до:
                                    <?= $order['cost_aft'] ?>р </p></div> </div>
                    </a>
                </li>
                <?php
            endwhile;
            ?>
        </ul>
    </div>
</section>
